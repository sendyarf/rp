<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reward Poin Mini App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src='//whephiwums.com/sdk.js' data-zone='9244919' data-sdk='show_9244919'></script>
  <style>
    .coin-animation {
      animation: coinSpin 1s ease-in-out;
    }
    @keyframes coinSpin {
      0% { transform: rotateY(0deg); opacity: 1; }
      100% { transform: rotateY(360deg); opacity: 0; }
    }
  </style>
</head>
<body class="bg-white text-gray-800 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white p-4 text-gray-800 text-center border-b border-gray-200">
    <h1 class="text-2xl font-bold">Reward Poin</h1>
    <p id="username" class="text-sm text-gray-600">Memuat pengguna...</p>
    <div class="mt-2 flex items-center justify-center">
      <span id="points" class="text-xl font-semibold">ü™ô 0 Poin</span>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow p-4">
    <div class="max-w-md mx-auto">
      <!-- Watch Ad Button -->
      <button id="watchAdBtn" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
        <span>‚ñ∂Ô∏è Tonton Iklan +1 Poin</span>
      </button>

      <!-- Instruction and Error Message -->
      <p class="text-sm text-gray-600 mt-2">Tonton iklan selama 15 detik hingga selesai untuk mendapatkan poin.</p>
      <p id="errorMsg" class="text-red-500 text-sm mt-2 hidden">Gagal memuat iklan atau iklan ditutup sebelum selesai. Coba lagi.</p>

      <!-- Sync Data Section -->
      <div class="mt-6">
        <h2 class="text-lg font-semibold">Sinkronisasi Manual (Cadangan)</h2>
        <button id="exportBtn" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-lg mt-2 transition duration-300">
          Ekspor Data
        </button>
        <div class="mt-2">
          <input id="importCode" type="text" placeholder="Masukkan kode sinkronisasi" class="w-full border border-gray-300 rounded-lg p-2 text-gray-800">
          <button id="importBtn" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-lg mt-2 transition duration-300">
            Impor Data
          </button>
        </div>
      </div>

      <!-- History Section -->
      <div class="mt-6">
        <h2 class="text-lg font-semibold">Riwayat Poin</h2>
        <ul id="historyList" class="mt-2 space-y-2"></ul>
      </div>

      <!-- Close Button -->
      <button id="closeBtn" class="w-full mt-4 bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
        Tutup Aplikasi
      </button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white p-4 text-gray-800 text-center border-t border-gray-200">
    <p>Dapatkan poin dengan menonton iklan!</p>
    <div class="mt-2">
      <button class="mx-2 hover:text-gray-500">Beranda</button>
      <button class="mx-2 hover:text-gray-500">Riwayat</button>
      <button class="mx-2 hover:text-gray-500">Panduan</button>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // Initialize Telegram Web App
    let userName = 'Pengguna';
    let userId = null;
    let telegramInitialized = false;

    function initializeTelegram() {
      if (window.Telegram && window.Telegram.WebApp) {
        try {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
          telegramInitialized = true;
          const user = window.Telegram.WebApp.initDataUnsafe.user;
          if (user) {
            userName = user.username ? `@${user.username}` : user.first_name || 'Pengguna';
            userId = user.id;
          }
          console.log('Telegram Web App initialized. User:', userName, 'ID:', userId);
          if (userId) {
            loadDataFromJson(userId);
          }
        } catch (e) {
          console.error('Failed to initialize Telegram Web App:', e);
        }
      } else {
        console.warn('Telegram Web App not available. Running outside Telegram environment.');
      }
      document.getElementById('username').innerText = `Halo, ${userName}!`;
    }

    window.addEventListener('load', initializeTelegram);

    // Initialize points and history
    let points = parseInt(localStorage.getItem('points')) || 0;
    let history = JSON.parse(localStorage.getItem('history')) || [];

    // Update points display
    function updatePoints() {
      document.getElementById('points').innerText = `ü™ô ${points} Poin`;
      localStorage.setItem('points', points);
      if (userId && telegramInitialized) {
        saveDataToJson(userId, points, history);
      }
    }

    // Update history display
    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      history.forEach(item => {
        const li = document.createElement('li');
        li.className = 'bg-white p-2 rounded shadow border border-gray-200';
        li.innerText = item;
        historyList.appendChild(li);
      });
      localStorage.setItem('history', JSON.stringify(history));
      if (userId && telegramInitialized) {
        saveDataToJson(userId, points, history);
      }
    }

    // Load data from JSON
    async function loadDataFromJson(userId) {
      try {
        const response = await fetch('/api/load-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await response.json();
        if (data.success && data.data) {
          points = data.data.points || 0;
          history = data.data.history || [];
          updatePoints();
          updateHistory();
          console.log('Data loaded from JSON:', data.data);
        } else {
          console.log('No data found for user, using localStorage');
        }
      } catch (e) {
        console.error('Failed to load data from JSON:', e);
      }
    }

    // Save data to JSON
    async function saveDataToJson(userId, points, history) {
      try {
        const response = await fetch('/api/save-data', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, points, history })
        });
        const data = await response.json();
        if (data.success) {
          console.log('Data saved to JSON');
        } else {
          console.error('Failed to save data to JSON:', data.error);
        }
      } catch (e) {
        console.error('Failed to save data to JSON:', e);
      }
    }

    // Show ad and handle points
    let adWatching = false;
    document.getElementById('watchAdBtn').addEventListener('click', () => {
      if (adWatching) return;
      const btn = document.getElementById('watchAdBtn');
      const errorMsg = document.getElementById('errorMsg');
      btn.disabled = true;
      btn.innerText = 'Memuat Iklan...';
      errorMsg.classList.add('hidden');
      adWatching = true;

      try {
        if (typeof show_9244919 === 'function') {
          show_9244919({
            type: 'inApp',
            inAppSettings: {
              frequency: 2,
              capping: 0.1,
              interval: 30,
              timeout: 5,
              everyPage: false
            }
          });
          console.log('Monetag ad triggered');
        } else {
          throw new Error('Monetag SDK not loaded');
        }

        setTimeout(() => {
          if (adWatching) {
            points += 1;
            const date = new Date().toLocaleString();
            history.push(`Iklan ditonton - +1 Poin pada ${date}`);
            updatePoints();
            updateHistory();

            const pointsDisplay = document.getElementById('points');
            pointsDisplay.classList.add('coin-animation');
            setTimeout(() => pointsDisplay.classList.remove('coin-animation'), 1000);
          }
          adWatching = false;
          btn.disabled = false;
          btn.innerHTML = '‚ñ∂Ô∏è Tonton Iklan +1 Poin';
        }, 15000);
      } catch (e) {
        console.error('Failed to show ad:', e);
        errorMsg.classList.remove('hidden');
        adWatching = false;
        btn.disabled = false;
        btn.innerHTML = '‚ñ∂Ô∏è Tonton Iklan +1 Poin';
      }
    });

    // Export data
    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = { points, history };
      const code = btoa(JSON.stringify(data));
      prompt('Salin kode ini dan kirim ke perangkat lain:', code);
    });

    // Import data
    document.getElementById('importBtn').addEventListener('click', () => {
      const code = document.getElementById('importCode').value;
      try {
        const data = JSON.parse(atob(code));
        if (data.points >= 0 && Array.isArray(data.history)) {
          points = data.points;
          history = data.history;
          updatePoints();
          updateHistory();
          alert('Data berhasil diimpor!');
          document.getElementById('importCode').value = '';
        } else {
          alert('Kode tidak valid.');
        }
      } catch (e) {
        alert('Kode tidak valid atau rusak.');
      }
    });

    // Close button
    document.getElementById('closeBtn').addEventListener('click', () => {
      if (telegramInitialized && window.Telegram && window.Telegram.WebApp) {
        console.log('Closing Telegram Web App');
        window.Telegram.WebApp.close();
      } else {
        alert('Tombol tutup hanya berfungsi di lingkungan Telegram. Pastikan aplikasi dijalankan melalui bot Telegram.');
        console.warn('Cannot close: Not in Telegram environment');
      }
    });

    // Detect if user interrupts ad
    window.addEventListener('beforeunload', () => {
      adWatching = false;
    });

    // Initial UI update
    updatePoints();
    updateHistory();
  </script>
</body>
</html>