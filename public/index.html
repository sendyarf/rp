<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reward Poin Mini App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    .coin-animation {
      animation: coinSpin 1s ease-in-out;
    }
    @keyframes coinSpin {
      0% { transform: rotateY(0deg); opacity: 1; }
      100% { transform: rotateY(360deg); opacity: 0; }
    }
  </style>
</head>
<body class="bg-white text-gray-800 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white p-4 text-gray-800 text-center border-b border-gray-200">
    <h1 class="text-2xl font-bold">Reward Poin</h1>
    <p id="username" class="text-sm text-gray-600">Memuat pengguna...</p>
    <div class="mt-2 flex items-center justify-center">
      <span id="points" class="text-xl font-semibold">ü™ô 0 Poin</span>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow p-4">
    <div class="max-w-md mx-auto">
      <!-- Watch Ad Button -->
      <button id="watchAdBtn" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center">
        <span>‚ñ∂Ô∏è Tonton Iklan +1 Poin</span>
      </button>

      <!-- Instruction and Error Message -->
      <p class="text-sm text-gray-600 mt-2">Tonton iklan selama 15 detik hingga selesai untuk mendapatkan poin.</p>
      <p id="errorMsg" class="text-red-500 text-sm mt-2 hidden"></p>

      <!-- Refresh Data Button -->
      <button id="refreshBtn" class="w-full bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-lg mt-4 transition duration-300">
        Segarkan Data
      </button>

      <!-- History Section -->
      <div class="mt-6">
        <h2 class="text-lg font-semibold">Riwayat Poin</h2>
        <ul id="historyList" class="mt-2 space-y-2"></ul>
      </div>

      <!-- Close Button -->
      <button id="closeBtn" class="w-full mt-4 bg-white border border-gray-300 hover:bg-gray-100 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-300">
        Tutup Aplikasi
      </button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-white p-4 text-gray-800 text-center border-t border-gray-200">
    <p>Dapatkan poin dengan menonton iklan!</p>
    <div class="mt-2">
      <button class="mx-2 hover:text-gray-500">Beranda</button>
      <button class="mx-2 hover:text-gray-500">Riwayat</button>
      <button class="mx-2 hover:text-gray-500">Panduan</button>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // Initialize Telegram Web App
    let userName = 'Pengguna';
    let userId = null;
    let telegramInitialized = false;

    function initializeTelegram() {
      if (window.Telegram && window.Telegram.WebApp) {
        try {
          window.Telegram.WebApp.ready();
          window.Telegram.WebApp.expand();
          telegramInitialized = true;
          const user = window.Telegram.WebApp.initDataUnsafe.user;
          if (user) {
            userName = user.username ? `@${user.username}` : user.first_name || 'Pengguna';
            userId = user.id;
          }
          console.log('Telegram Web App initialized. User:', userName, 'ID:', userId, 'Platform:', window.navigator.userAgent);
          if (userId) {
            loadDataFromJson(userId, true);
          } else {
            console.error('No userId found');
            showError('Gagal menginisialisasi pengguna. Buka melalui Telegram.');
          }
        } catch (e) {
          console.error('Failed to initialize Telegram Web App:', e);
          showError('Gagal menginisialisasi aplikasi. Coba lagi.');
        }
      } else {
        console.warn('Telegram Web App not available.');
        showError('Aplikasi harus dijalankan melalui Telegram.');
      }
      document.getElementById('username').innerText = `Halo, ${userName}!`;
    }

    window.addEventListener('load', initializeTelegram);

    // Initialize points and history
    let points = parseInt(localStorage.getItem('points')) || 0;
    let history = JSON.parse(localStorage.getItem('history')) || [];

    // Show error message
    function showError(message) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.innerText = message;
      errorMsg.classList.remove('hidden');
      setTimeout(() => errorMsg.classList.add('hidden'), 5000);
    }

    // Update points display
    function updatePoints() {
      document.getElementById('points').innerText = `ü™ô ${points} Poin`;
      localStorage.setItem('points', points);
    }

    // Update history display
    function updateHistory() {
      const historyList = document.getElementById('historyList');
      historyList.innerHTML = '';
      history.forEach(item => {
        const li = document.createElement('li');
        li.className = 'bg-white p-2 rounded shadow border border-gray-200';
        li.innerText = item;
        historyList.appendChild(li);
      });
      localStorage.setItem('history', JSON.stringify(history));
    }

    // Load data from JSON with retry
    async function loadDataFromJson(userId, isInitial = false) {
      let retries = 3;
      while (retries > 0) {
        try {
          console.log(`Loading data for userId: ${userId}, Attempt: ${4 - retries}`);
          const response = await fetch('/api/load-data', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Cache-Control': 'no-cache'
            },
            body: JSON.stringify({ userId })
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          if (data.success && data.data) {
            points = data.data.points || 0;
            history = data.data.history || [];
            updatePoints();
            updateHistory();
            console.log('Data loaded from JSON:', data.data);
            return true;
          } else {
            console.log('No data found for userId:', userId);
            if (isInitial) {
              updatePoints();
              updateHistory();
            }
            return false;
          }
        } catch (e) {
          console.error('Failed to load data from JSON:', e.message);
          retries--;
          if (retries === 0) {
            showError('Gagal memuat data. Server tidak ditemukan atau koneksi bermasalah.');
            if (isInitial) {
              updatePoints();
              updateHistory();
            }
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    // Save data to JSON with retry
    async function saveDataToJson(userId, points, history) {
      if (!userId) {
        console.error('Cannot save data: userId is missing');
        showError('Gagal menyimpan: Pengguna tidak terdeteksi.');
        return false;
      }
      let retries = 3;
      while (retries > 0) {
        try {
          console.log(`Saving data for userId: ${userId}, Attempt: ${4 - retries}`);
          const response = await fetch('/api/save-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId, points, history })
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          if (data.success) {
            console.log('Data saved to JSON for userId:', userId);
            return true;
          } else {
            console.error('Failed to save data to JSON:', data.error);
            retries--;
            if (retries === 0) {
              showError(`Gagal menyimpan data: ${data.error}`);
              return false;
            }
          }
        } catch (e) {
          console.error('Failed to save data to JSON:', e.message);
          retries--;
          if (retries === 0) {
            showError('Gagal menyimpan data. Server tidak ditemukan atau koneksi bermasalah.');
            return false;
          }
          await new Promise(resolve => setTimeout(resolve, 1000));
        }
      }
    }

    // Refresh data button
    document.getElementById('refreshBtn').addEventListener('click', async () => {
      if (!userId) {
        console.warn('No userId available for refresh');
        showError('Gagal menyegarkan: Buka melalui Telegram.');
        return;
      }
      console.log('Refreshing data for userId:', userId);
      const success = await loadDataFromJson(userId);
      if (success) {
        showError('Data berhasil disegarkan.');
      } else {
        showError('Gagal menyegarkan data. Coba lagi nanti.');
      }
    });

    // Load Monetag script dynamically
    let monetagLoaded = false;
    function loadMonetagScript() {
      if (monetagLoaded) return;
      const script = document.createElement('script');
      script.src = '//whephiwums.com/sdk.js';
      script.setAttribute('data-zone', '9244919');
      script.setAttribute('data-sdk', 'show_9244919');
      document.head.appendChild(script);
      script.onload = () => {
        console.log('Monetag script loaded');
        monetagLoaded = true;
      };
      script.onerror = () => {
        console.error('Failed to load Monetag script');
        showError('Gagal memuat iklan. Coba lagi.');
      };
    }

    // Show ad and handle points
    let adWatching = false;
    document.getElementById('watchAdBtn').addEventListener('click', async (event) => {
      event.preventDefault();
      if (adWatching) {
        console.log('Ad already in progress');
        return;
      }

      if (!userId) {
        console.error('Cannot proceed: userId is missing');
        showError('Gagal memuat iklan: Pengguna tidak terdeteksi.');
        return;
      }

      if (!monetagLoaded) {
        loadMonetagScript();
        await new Promise(resolve => setTimeout(resolve, 1000));
      }

      const btn = document.getElementById('watchAdBtn');
      const errorMsg = document.getElementById('errorMsg');
      btn.disabled = true;
      btn.innerText = 'Memuat Iklan...';
      errorMsg.classList.add('hidden');
      adWatching = true;

      try {
        if (typeof show_9244919 === 'function') {
          console.log('Triggering Monetag ad');
          show_9244919({
            type: 'inApp',
            inAppSettings: {
              frequency: 1000,
              capping: 0.1,
              interval: 60,
              timeout: 5,
              everyPage: false
            }
          });
        } else {
          throw new Error('Monetag SDK not loaded');
        }

        setTimeout(async () => {
          if (adWatching) {
            points += 1;
            const date = new Date().toLocaleString();
            history.push(`Iklan ditonton - +1 Poin pada ${date}`);
            updatePoints();
            updateHistory();
            const saved = await saveDataToJson(userId, points, history);
            if (!saved) {
              showError('Poin bertambah, tetapi gagal disinkronkan ke server.');
            }

            const pointsDisplay = document.getElementById('points');
            pointsDisplay.classList.add('coin-animation');
            setTimeout(() => pointsDisplay.classList.remove('coin-animation'), 1000);
          }
          adWatching = false;
          btn.disabled = false;
          btn.innerHTML = '‚ñ∂Ô∏è Tonton Iklan +1 Poin';
        }, 15000);
      } catch (e) {
        console.error('Failed to show ad:', e.message);
        showError('Gagal memuat iklan. Coba lagi.');
        adWatching = false;
        btn.disabled = false;
        btn.innerHTML = '‚ñ∂Ô∏è Tonton Iklan +1 Poin';
      }
    });

    // Close button
    document.getElementById('closeBtn').addEventListener('click', () => {
      if (telegramInitialized && window.Telegram && window.Telegram.WebApp) {
        console.log('Closing Telegram Web App');
        window.Telegram.WebApp.close();
      } else {
        alert('Tombol tutup hanya berfungsi di lingkungan Telegram.');
        console.warn('Cannot close: Not in Telegram environment');
      }
    });

    // Detect if user interrupts ad
    window.addEventListener('beforeunload', () => {
      adWatching = false;
    });

    // Initial UI update
    updatePoints();
    updateHistory();
  </script>
</body>
</html>